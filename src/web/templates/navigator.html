{% extends "base.html" %}

{% block navigator %}
<!-- Header -->
<header class="koine-nav-header">
    <div class="koine-nav-brand">
        <!-- Minimal Dove Logo (nav bar size) -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80" width="36" height="24">
            <ellipse cx="60" cy="38" rx="12" ry="16" fill="#e8d5a3" opacity="0.85" />
            <path d="M48,32 Q20,8 -2,2 Q15,18 28,28 Q38,34 44,35Z" fill="#d4c18a" opacity="0.75" />
            <path d="M46,28 Q22,10 8,6 Q22,20 34,28Z" fill="#e8dbb0" opacity="0.5" />
            <path d="M72,32 Q100,8 122,2 Q105,18 92,28 Q82,34 76,35Z" fill="#d4c18a" opacity="0.75" />
            <path d="M74,28 Q98,10 112,6 Q98,20 86,28Z" fill="#e8dbb0" opacity="0.5" />
            <circle cx="60" cy="22" r="6.5" fill="#f0e4c0" opacity="0.9" />
            <path d="M55,52 L60,68 L65,52" fill="#d4c18a" opacity="0.5" />
        </svg>
        <span class="koine-wordmark">Navigator</span>
    </div>

    <div class="koine-nav-controls">
        <button class="koine-icon-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
            <!-- Sun icon (shown in dark mode) -->
            <svg id="theme-icon-sun" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <!-- Moon icon (shown in light mode) -->
            <svg id="theme-icon-moon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
        <button class="koine-icon-btn" title="New Chat">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>
        <button class="koine-icon-btn" title="History">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>
</header>

<!-- Chat Area -->
<div class="koine-chat-area">
    <div class="koine-welcome">

        <!-- System status -->
        <div class="koine-system-status">
            <span class="koine-status-dot"></span> System Online · Local Processing
        </div>

        <!-- Minimal Dove (welcome hero) -->
        <svg class="koine-welcome-logo koine-animate-glow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80"
            width="80">
            <ellipse cx="60" cy="38" rx="12" ry="16" fill="#e8d5a3" opacity="0.85" />
            <path d="M48,32 Q20,8 -2,2 Q15,18 28,28 Q38,34 44,35Z" fill="#d4c18a" opacity="0.75" />
            <path d="M46,28 Q22,10 8,6 Q22,20 34,28Z" fill="#e8dbb0" opacity="0.5" />
            <path d="M72,32 Q100,8 122,2 Q105,18 92,28 Q82,34 76,35Z" fill="#d4c18a" opacity="0.75" />
            <path d="M74,28 Q98,10 112,6 Q98,20 86,28Z" fill="#e8dbb0" opacity="0.5" />
            <circle cx="60" cy="22" r="6.5" fill="#f0e4c0" opacity="0.9" />
            <path d="M55,52 L60,68 L65,52" fill="#d4c18a" opacity="0.5" />
        </svg>

        <div class="koine-welcome-text">
            <p>Ask regarding your ingested knowledge, or let me guide you to the unknown.
            </p>
        </div>

        <div class="koine-suggestions koine-stagger">
            <button class="koine-suggestion-card koine-animate-fade-in-up">
                <span class="koine-overline">Explore</span>
                <span>What's new in my library?</span>
            </button>
            <button class="koine-suggestion-card koine-animate-fade-in-up">
                <span class="koine-overline">Synthesize</span>
                <span>Connect recent papers</span>
            </button>
            <button class="koine-suggestion-card koine-animate-fade-in-up">
                <span class="koine-overline">Discover</span>
                <span>Surface unknown unknowns</span>
            </button>
            <button class="koine-suggestion-card koine-animate-fade-in-up">
                <span class="koine-overline">Summarize</span>
                <span>Today's knowledge landscape</span>
            </button>
        </div>
    </div>
</div>

<!-- Input Area -->
<div class="koine-input-area">
    <div class="koine-input-wrapper">
        <textarea rows="1" placeholder="ask a question..." class="koine-chat-input"></textarea>
        <button class="koine-send-btn" title="Send">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
            </svg>
        </button>
    </div>
    <div class="koine-input-footer">
        <small>confidential · local inference · no external apis</small>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/graph.css">
{% endblock %}


{% block visualization %}
<!-- Cytoscape Canvas -->
<div id="cy"></div>

<!-- Sidebar Toggle -->
<button class="graph-sidebar-toggle" onclick="toggleGraphSidebar()" title="Toggle sidebar">▶</button>

<!-- Graph Sidebar -->
<div class="graph-sidebar">
    <div class="graph-sidebar-header">
        <h2>DKIA Knowledge Graph</h2>
        <div class="graph-level-indicator" id="level-indicator">Loading…</div>
    </div>

    <div class="graph-sidebar-content">
        <!-- Node Info -->
        <div id="node-info">
            <div class="placeholder">Click a community node to expand it<br>Click a community in the legend to focus it
            </div>
        </div>

        <!-- Chunk Panel -->
        <div id="chunk-panel"></div>

        <!-- Legend -->
        <div class="graph-legend-header">COMMUNITIES</div>
        <div id="legend"></div>
    </div>

    <!-- Controls -->
    <div class="graph-controls">
        <button onclick="graphFit()">Fit</button>
        <button onclick="graphCollapseAll()">Collapse All</button>
        <button onclick="graphReset()">Reset</button>
    </div>

    <!-- Stats -->
    <div class="graph-stats" id="graph-stats">
        40 communities · 158 entities · 96 chunks
    </div>
</div>

<!-- Chunk Tooltip (absolute positioned) -->
<div class="chunk-tooltip" id="chunk-tooltip"></div>
{% endblock %}


{% block scripts %}
<script src="/static/js/sidebar.js"></script>
<script src="/static/js/graph.js?v=11"></script>
<script>
    (function () {
        // Sync icon state on load
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        document.getElementById('theme-icon-sun').style.display = current === 'dark' ? '' : 'none';
        document.getElementById('theme-icon-moon').style.display = current === 'light' ? '' : 'none';

        document.getElementById('theme-toggle').addEventListener('click', function () {
            var cur = document.documentElement.getAttribute('data-theme') || 'dark';
            var next = cur === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('koine-theme', next);

            // Update icons
            document.getElementById('theme-icon-sun').style.display = next === 'dark' ? '' : 'none';
            document.getElementById('theme-icon-moon').style.display = next === 'light' ? '' : 'none';

            // Update meta theme-color
            var meta = document.getElementById('meta-theme-color');
            if (meta) meta.content = next === 'dark' ? '#08080e' : '#fdf9f0';

            // Re-apply Cytoscape graph styles for new theme
            if (window.reinitGraphStyles) window.reinitGraphStyles();
        });
    })();
</script>
{% endblock %}